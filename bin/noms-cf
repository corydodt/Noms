#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

cf() {
    aws cloudformation "$@"
}

build() {
    stackName="$1"
    if [ -z "$stackName" ]; then
        echo "** Usage: noms-cf build <stackName>" 1>&2
        return 1
    fi
    echo $stackName > .last-stack

    cf create-stack \
        --stack-name $stackName \
        --template-body file://<(cat $1.yml | sed '/^\s*#/d')
}

changeset() {
    stackName="$1"
    if [ -z "$stackName" ]; then
        echo "** Usage: noms-cf changeset <stackName>" 1>&2
        return 1
    fi
    echo $stackName > .last-stack
    cf create-change-set \
        --stack-name $stackName \
        --change-set-name $stackName \
        --template-body file://<(cat $1.yml | sed '/^\s*#/d')
    cf execute-change-set \
        --stack-name $stackName \
        --change-set-name $stackName
}

delete() {
    last=$(cat .last-stack)
    echo $last
    cf delete-stack --stack-name $last
    rm .last-stack
}

set -a
. ./deployment/build/env
set +a

jentemplate deployment/ecs.yml.in > ecs.yml
jentemplate deployment/nomsite.yml.in > nomsite.yml

aws configure set region us-west-2

subCommand=$1
shift
$subCommand "$@"

#!/bin/bash -x

subCommand=$1
shift
cf='aws --profile corygoonmill cloudformation'

build() {
stackName="$1"
echo $stackName > .last-stack

$cf create-stack \
    --stack-name $stackName \
    --template-body file://<(cat $1.yml | sed '/^\s*#/d')
}

delete() {
    last=$(cat .last-stack)
    echo $last
    $cf delete-stack --stack-name $last
    rm .last-stack
}

set -a
. ./build/env
set +a

jentemplate deployment/ecs.yml.in > ecs.yml
jentemplate deployment/nomsite.yml.in > nomsite.yml

$subCommand "$@"

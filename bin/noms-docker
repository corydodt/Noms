#!/bin/bash

set -e

export NOMS_VERSION=$(git describe --all | cut -d/ -f2-)
if echo $NOMS_VERSION | grep / > /dev/null; then
    echo "** Invalid NOMS_VERSION=$NOMS_VERSION" 1>&2
    echo "** You should build from either the HEAD of this branch or a tagged revision" 1>&2
    if echo $NOMS_VERSION | grep origin > /dev/null; then
        echo "** (You appear to be on an old commit that doesn't have a tag)" 1>&2
    fi
    exit 1
fi

export NOMS_DB_HOST=${NOMS_DB_HOST:-mongo}
export NOMS_HOSTNAME=${NOMS_HOSTNAME:-dev.nomsbook.com}
export NOMS_CERTBOT_FLAGS=${NOMS_CERTBOT_FLAGS:---staging}

buildd=./build/$NOMS_VERSION
rm -rf $buildd
mkdir -p $buildd
echo export NOMS_VERSION="$NOMS_VERSION" | tee -a $buildd/env
echo export NOMS_DB_HOST="$NOMS_DB_HOST" | tee -a $buildd/env
echo export NOMS_HOSTNAME="$NOMS_HOSTNAME" | tee -a $buildd/env
echo export NOMS_CERTBOT_FLAGS="$NOMS_CERTBOT_FLAGS" | tee -a $buildd/env

docker-compose -f deployment/docker-compose.yml "$@"
